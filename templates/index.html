<!DOCTYPE html>
<html>
<head>
  <title>GitHub Events Monitor</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    h2 {
      color: #333;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    h2:before {
      content: "üìä";
    }
    
    .controls {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #3498db;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    #refreshBtn { 
      background: #3498db; 
      color: white; 
    }
    #refreshBtn:hover { background: #2980b9; }
    
    #clearBtn { 
      background: #e74c3c; 
      color: white; 
    }
    #clearBtn:hover { background: #c0392b; }
    
    #debugBtn { 
      background: #9b59b6; 
      color: white; 
    }
    #debugBtn:hover { background: #8e44ad; }
    
    #resortBtn { 
      background: #2ecc71; 
      color: white; 
    }
    #resortBtn:hover { background: #27ae60; }
    
    #status {
      margin-left: 15px;
      padding: 8px 15px;
      background: white;
      border-radius: 20px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      flex-grow: 1;
    }
    
    /* Table Styles */
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      max-height: 600px;
      overflow-y: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }
    
    th {
      background: linear-gradient(to right, #2c3e50, #34495e);
      color: white;
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
      border-bottom: 2px solid #1a252f;
    }
    
    th:nth-child(5) {
      background: linear-gradient(to right, #34495e, #2c3e50);
      cursor: pointer;
    }
    
    th:nth-child(5):hover {
      background: linear-gradient(to right, #3d566e, #34495e);
    }
    
    th:nth-child(5):after {
      content: " ‚¨á‚¨Ü";
      font-size: 12px;
      opacity: 0.7;
    }
    
    td {
      padding: 14px 12px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: top;
    }
    
    tr:hover {
      background: #f9f9f9;
    }
    
    /* Column Widths */
    th:nth-child(1), td:nth-child(1) { width: 150px; min-width: 150px; }
    th:nth-child(2), td:nth-child(2) { width: 250px; min-width: 250px; }
    th:nth-child(3), td:nth-child(3) { width: 150px; min-width: 150px; }
    th:nth-child(4), td:nth-child(4) { width: 350px; min-width: 350px; }
    th:nth-child(5), td:nth-child(5) { width: 220px; min-width: 220px; }
    th:nth-child(6), td:nth-child(6) { width: 150px; min-width: 150px; }
    
    /* Time column styling */
    .time-cell {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      color: #2c3e50;
      background: #f8f9fa;
      padding: 8px 10px;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }
    
    .time-now {
      background: #fff3cd;
      border-color: #ffeaa7;
      font-weight: bold;
    }
    
    .time-recent {
      background: #d4edda;
      border-color: #c3e6cb;
    }
    
    /* Event Type Styling */
    .event-type {
      font-weight: bold;
      padding: 6px 12px;
      border-radius: 20px;
      color: white;
      font-size: 12px;
      display: inline-block;
      text-align: center;
      min-width: 120px;
    }
    
    .push-type { 
      background: linear-gradient(to right, #3498db, #2980b9);
      border: 1px solid #2980b9;
    }
    
    .pr-created-type { 
      background: linear-gradient(to right, #f39c12, #e67e22);
      border: 1px solid #e67e22;
    }
    
    .pr-merged-type { 
      background: linear-gradient(to right, #27ae60, #229954);
      border: 1px solid #229954;
    }
    
    .pr-closed-type { 
      background: linear-gradient(to right, #e74c3c, #c0392b);
      border: 1px solid #c0392b;
    }
    
    .merge-commit-type { 
      background: linear-gradient(to right, #9b59b6, #8e44ad);
      border: 1px solid #8e44ad;
    }
    
    .pr-updated-type { 
      background: linear-gradient(to right, #17a2b8, #138496);
      border: 1px solid #138496;
    }
    
    /* Message cell with ellipsis - FIXED */
    .message-cell {
      position: relative;
    }
    
    .message-text {
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      line-height: 1.4;
      max-height: 2.8em;
    }
    
    .message-cell:hover .message-text {
      -webkit-line-clamp: unset;
      line-clamp: unset;
      overflow: visible;
      background: white;
      position: absolute;
      z-index: 20;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 400px;
      left: 0;
      top: 100%;
      max-height: 200px;
      overflow-y: auto;
    }
    
    /* Details cell */
    .details-cell {
      font-family: 'Courier New', monospace;
      background: #f8f9fa;
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
      font-size: 13px;
      display: inline-block;
    }
    
    /* New event highlight */
    @keyframes highlightNew {
      0% { background-color: #ffffcc; }
      100% { background-color: inherit; }
    }
    
    .new-event {
      animation: highlightNew 2s ease-out;
    }
    
    /* Debug Info */
    #debugInfo {
      display: none;
      margin-top: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #9b59b6;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 16px;
    }
    
    .empty-state:before {
      content: "üì≠";
      font-size: 48px;
      display: block;
      margin-bottom: 15px;
    }
    
    /* Timeline indicator */
    .timeline-indicator {
      position: absolute;
      left: -10px;
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #3498db;
    }
    
    tr:hover .timeline-indicator {
      background: #e74c3c;
      width: 8px;
      height: 8px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 15px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      button {
        width: 100%;
        justify-content: center;
      }
      
      #status {
        margin-left: 0;
        margin-top: 10px;
        text-align: center;
      }
      
      .table-container {
        border-radius: 5px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h2>GitHub Events Monitor</h2>
  
  <div class="controls">
    <button id="refreshBtn" onclick="loadEvents()">
      <span>üîÑ</span> Refresh
    </button>
    <button id="clearBtn" onclick="clearEvents()">
      <span>üóëÔ∏è</span> Clear All
    </button>
    <button id="debugBtn" onclick="showDebug()">
      <span>üêõ</span> Debug Info
    </button>
    <button id="resortBtn" onclick="resortEvents()">
      <span>üìä</span> Re-sort by Time
    </button>
    <span id="status">Loading events...</span>
  </div>
  
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Repository</th>
          <th>Author</th>
          <th>Message</th>
          <th onclick="toggleSort()" title="Click to toggle sort order">Time ‚ñº</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="data"></tbody>
    </table>
  </div>
  
  <div id="debugInfo"></div>
</div>

<script>
let sortDescending = true;
let lastEventsCount = 0;

async function loadEvents() {
  try {
    const res = await fetch("/events");
    const events = await res.json();
    
    const tbody = document.getElementById("data");
    const statusEl = document.getElementById("status");
    
    if (events.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6">
            <div class="empty-state">
              No events yet. Create a PR or push some code!
            </div>
          </td>
        </tr>
      `;
      statusEl.innerHTML = `<span style="color:#999">üì≠ No events</span>`;
      lastEventsCount = 0;
      return;
    }
    
    // Check if new events were added
    const hasNewEvents = events.length > lastEventsCount;
    lastEventsCount = events.length;
    
    // Sort events based on current sort order
    const sortedEvents = [...events];
    if (!sortDescending) {
      sortedEvents.reverse();
    }
    
    tbody.innerHTML = "";
    
    // Get current time for highlighting
    const now = new Date();
    const oneHourAgo = new Date(now.getTime() - (60 * 60 * 1000));
    
    sortedEvents.forEach((e, index) => {
      // Determine styling based on event type
      let typeClass = "";
      let typeText = "";
      
      switch(e.type) {
        case "PUSH":
          typeClass = "push-type";
          typeText = "üì§ PUSH";
          break;
        case "PR_CREATED":
          typeClass = "pr-created-type";
          typeText = "üìù PR CREATED";
          break;
        case "PR_MERGED":
          typeClass = "pr-merged-type";
          typeText = "‚úÖ PR MERGED";
          break;
        case "PR_CLOSED":
          typeClass = "pr-closed-type";
          typeText = "‚ùå PR CLOSED";
          break;
        case "MERGE_COMMIT":
          typeClass = "merge-commit-type";
          typeText = "üîÄ MERGE COMMIT";
          break;
        case "PR_UPDATED":
          typeClass = "pr-updated-type";
          typeText = "üìù PR UPDATED";
          break;
        default:
          typeText = e.type;
      }
      
      const details = e.sha ? `SHA: ${e.sha}` : 
                     e.pr_number ? `PR #${e.pr_number}` : 
                     "N/A";
      
      // Parse and format time
      let timeStr = "N/A";
      let timeClass = "time-cell";
      if (e.time) {
        const eventTime = new Date(e.time);
        timeStr = eventTime.toLocaleString();
        
        // Highlight recent events
        if (eventTime > oneHourAgo) {
          timeClass += " time-recent";
        }
        if (eventTime > new Date(now.getTime() - (5 * 60 * 1000))) {
          timeClass += " time-now";
        }
      }
      
      // Check if this is a new event
      const rowClass = hasNewEvents && index === 0 ? "new-event" : "";
      
      tbody.innerHTML += `
        <tr class="${rowClass}">
          <td>
            <div style="position: relative;">
              <span class="timeline-indicator"></span>
              <span class="event-type ${typeClass}">${typeText}</span>
            </div>
          </td>
          <td style="font-weight: 600; color: #2c3e50;">
            ${e.repo}
          </td>
          <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: #666;">üë§</span>
              ${e.author}
            </div>
          </td>
          <td class="message-cell">
            <div class="message-text" title="${e.message}">
              ${e.message}
            </div>
          </td>
          <td>
            <div class="${timeClass}">
              ${timeStr}
            </div>
          </td>
          <td>
            <span class="details-cell">${details}</span>
          </td>
        </tr>
      `;
    });
    
    // Update status with timing info
    const latestTime = sortedEvents.length > 0 ? new Date(sortedEvents[0].time) : null;
    const timeAgo = latestTime ? 
      `Latest: ${timeSince(latestTime)} ago` : 
      '';
    
    const statusColor = events.length > 0 ? "#27ae60" : "#999";
    statusEl.innerHTML = `
      <span style="color:${statusColor}">
        üìà ${events.length} events | ${timeAgo} | 
        Sorted: ${sortDescending ? 'Newest first ‚ñº' : 'Oldest first ‚ñ≤'}
      </span>
    `;
    
  } catch (error) {
    console.error("Error loading events:", error);
    document.getElementById("status").innerHTML = 
      `<span style="color:#e74c3c">‚ùå Error loading events</span>`;
  }
}

function timeSince(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  
  let interval = Math.floor(seconds / 31536000);
  if (interval >= 1) return interval + " year" + (interval > 1 ? "s" : "");
  
  interval = Math.floor(seconds / 2592000);
  if (interval >= 1) return interval + " month" + (interval > 1 ? "s" : "");
  
  interval = Math.floor(seconds / 86400);
  if (interval >= 1) return interval + " day" + (interval > 1 ? "s" : "");
  
  interval = Math.floor(seconds / 3600);
  if (interval >= 1) return interval + " hour" + (interval > 1 ? "s" : "");
  
  interval = Math.floor(seconds / 60);
  if (interval >= 1) return interval + " minute" + (interval > 1 ? "s" : "");
  
  return Math.floor(seconds) + " seconds";
}

function toggleSort() {
  sortDescending = !sortDescending;
  loadEvents();
}

async function clearEvents() {
  if (confirm("Are you sure you want to clear all events? This action cannot be undone.")) {
    try {
      await fetch("/clear", { method: "POST" });
      loadEvents();
    } catch (error) {
      console.error("Error clearing events:", error);
      alert("Error clearing events. Check console for details.");
    }
  }
}

async function resortEvents() {
  try {
    const res = await fetch("/resort", { method: "POST" });
    const data = await res.json();
    alert(`Events resorted. Latest event: ${data.latest_time}`);
    loadEvents();
  } catch (error) {
    console.error("Error resorting events:", error);
  }
}

async function showDebug() {
  try {
    const res = await fetch("/debug");
    const data = await res.json();
    
    const debugDiv = document.getElementById("debugInfo");
    debugDiv.style.display = "block";
    debugDiv.innerHTML = `
      <h3 style="margin-top:0; color:#9b59b6;">üêõ Debug Information</h3>
      <p><strong>Total Events:</strong> ${data.total_events}</p>
      <p><strong>Event Types Seen:</strong> ${data.event_types.join(", ")}</p>
      <h4>Time Debug (Last 10 events):</h4>
      <pre style="background:#2c3e50;color:white;padding:15px;border-radius:5px;overflow:auto;">
${JSON.stringify(data.time_debug, null, 2)}</pre>
      <h4>Recent Events (Last 10):</h4>
      <pre style="background:#34495e;color:white;padding:15px;border-radius:5px;overflow:auto;">
${JSON.stringify(data.events, null, 2)}</pre>
      <button onclick="document.getElementById('debugInfo').style.display='none'" 
              style="margin-top:10px;background:#95a5a6;color:white;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;">
        Close Debug
      </button>
    `;
  } catch (error) {
    console.error("Error fetching debug info:", error);
  }
}

// Load on page load
loadEvents();
// Auto-refresh every 3 seconds
setInterval(loadEvents, 3000);
</script>

</body>
</html>